{% extends 'base.html' %}

{% block title %}Get Recommendations - TechAdvisor{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-80px)] bg-brand-50 py-12 flex flex-col justify-center relative overflow-hidden">
    <!-- Abstract Background Decor -->
    <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl h-[600px] bg-white rounded-full blur-3xl opacity-60 pointer-events-none">
    </div>

    <div class="relative max-w-2xl mx-auto px-4 sm:px-6 w-full z-10">
        <!-- Progress Indicator -->
        <div class="mb-10 flex items-center justify-center space-x-2">
            <span class="text-xs font-bold text-brand-900 tracking-wider uppercase">Step <span
                    id="currentStepDisplay">1</span> of 4</span>
            <div class="w-24 h-1 bg-brand-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-brand-900 transition-all duration-500 ease-out w-1/4"></div>
            </div>
        </div>

        <!-- Header -->
        <div class="text-center mb-10 reveal">
            <h1 class="text-3xl md:text-4xl font-display font-bold text-brand-900 mb-3 tracking-tight">Let's find your
                match.</h1>
            <p class="text-brand-500 text-lg font-light">Tell us a bit about what you need.</p>
        </div>

        <!-- Questionnaire Card -->
        <div class="bg-white/80 backdrop-blur-xl border border-white/50 rounded-3xl shadow-[0_4px_30px_rgba(0,0,0,0.03)] p-6 md:p-10 reveal"
            style="animation-delay: 100ms;">
            <form method="POST" action="{{ url_for('user.recommend') }}" id="recommendForm">
                {{ form.hidden_tag() }}

                <!-- Question 1: Category -->
                <div class="question-section" data-question="1">
                    <h2 class="text-xl font-bold text-brand-900 mb-6 flex items-center">
                        <span
                            class="w-8 h-8 rounded-full bg-brand-100 text-brand-900 flex items-center justify-center text-sm mr-3 font-bold">1</span>
                        What type of device are you looking for?
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for value, label in form.category.choices %}
                        <label
                            class="group relative flex items-center p-4 border border-brand-200 rounded-2xl cursor-pointer hover:border-brand-900 hover:bg-brand-50 transition-all duration-200">
                            <input type="radio" name="category" value="{{ value }}" class="sr-only peer">

                            <!-- Custom Radio Visual -->
                            <div
                                class="w-5 h-5 rounded-full border border-brand-300 mr-4 flex items-center justify-center peer-checked:border-brand-900 peer-checked:bg-brand-900 transition-colors">
                                <div class="w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
                            </div>

                            <!-- Content -->
                            <div class="flex-1">
                                <span class="block font-semibold text-brand-900 peer-checked:text-black">{{ label
                                    }}</span>
                            </div>

                            <!-- Icon -->
                            <div
                                class="text-brand-400 group-hover:text-brand-900 peer-checked:text-brand-900 transition-colors">
                                {% if value == 'smartphone' %}
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z">
                                    </path>
                                </svg>
                                {% elif value == 'laptop' %}
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                    </path>
                                </svg>
                                {% endif %}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Question 2: Budget -->
                <div class="question-section mt-12 opacity-30 pointer-events-none transition-all duration-500 blur-sm"
                    data-question="2">
                    <h2 class="text-xl font-bold text-brand-900 mb-6 flex items-center">
                        <span
                            class="w-8 h-8 rounded-full bg-brand-100 text-brand-900 flex items-center justify-center text-sm mr-3 font-bold">2</span>
                        What is your maximum budget?
                    </h2>

                    <div class="bg-brand-50 rounded-2xl p-6 md:p-8">
                        <div class="text-center mb-8">
                            <span class="text-4xl font-display font-bold text-brand-900 tracking-tight">$<span
                                    id="budgetValue">1000</span></span>
                        </div>

                        <input type="range" name="budget" id="budgetSlider" min="100" max="5000" value="1000" step="50"
                            class="w-full h-2 bg-brand-200 rounded-full appearance-none cursor-pointer accent-brand-900 mb-8">

                        <div class="grid grid-cols-3 gap-3">
                            <button type="button"
                                class="budget-preset py-2 px-3 bg-white border border-brand-200 rounded-lg text-sm font-medium text-brand-600 hover:border-brand-400 hover:text-brand-900 transition-colors"
                                data-value="500">
                                Entry (< $500) </button>
                                    <button type="button"
                                        class="budget-preset py-2 px-3 bg-white border border-brand-200 rounded-lg text-sm font-medium text-brand-600 hover:border-brand-400 hover:text-brand-900 transition-colors"
                                        data-value="1500">
                                        Mid ($1.5k)
                                    </button>
                                    <button type="button"
                                        class="budget-preset py-2 px-3 bg-white border border-brand-200 rounded-lg text-sm font-medium text-brand-600 hover:border-brand-400 hover:text-brand-900 transition-colors"
                                        data-value="3000">
                                        Pro ($3k+)
                                    </button>
                        </div>
                    </div>
                </div>

                <!-- Question 3: Usage -->
                <div class="question-section mt-12 opacity-30 pointer-events-none transition-all duration-500 blur-sm"
                    data-question="3">
                    <h2 class="text-xl font-bold text-brand-900 mb-6 flex items-center">
                        <span
                            class="w-8 h-8 rounded-full bg-brand-100 text-brand-900 flex items-center justify-center text-sm mr-3 font-bold">3</span>
                        Primary usage?
                    </h2>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        {% for value, label in form.usage_type.choices %}
                        <label
                            class="group relative flex flex-col items-center justify-center p-4 border border-brand-200 rounded-2xl cursor-pointer hover:border-brand-900 hover:bg-brand-50 transition-all duration-200 text-center h-32">
                            <input type="radio" name="usage_type" value="{{ value }}" class="sr-only peer">
                            <div
                                class="absolute inset-0 border-2 border-brand-900 rounded-2xl opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity">
                            </div>

                            <!-- Icon -->
                            <div
                                class="w-10 h-10 mb-3 text-brand-400 group-hover:text-brand-900 peer-checked:text-brand-900 transition-colors">
                                {% if value == 'everyday' %}
                                <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                {% elif value == 'business' %}
                                <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                    </path>
                                </svg>
                                {% elif value == 'gaming' %}
                                <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                                    </path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                {% else %}
                                <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                    </path>
                                </svg>
                                {% endif %}
                            </div>
                            <span
                                class="text-xs font-semibold uppercase tracking-wide text-brand-500 peer-checked:text-brand-900">{{
                                label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Question 4: Brand -->
                <div class="question-section mt-12 opacity-30 pointer-events-none transition-all duration-500 blur-sm"
                    data-question="4">
                    <h2 class="text-xl font-bold text-brand-900 mb-6 flex items-center">
                        <span
                            class="w-8 h-8 rounded-full bg-brand-100 text-brand-900 flex items-center justify-center text-sm mr-3 font-bold">4</span>
                        Any brand preference? <span class="text-sm font-normal text-brand-400 ml-2">(Optional)</span>
                    </h2>

                    {{ form.preferred_brand(class="w-full px-5 py-4 text-lg border border-brand-200 rounded-xl
                    focus:ring-2 focus:ring-brand-900 focus:border-transparent transition-all outline-none bg-brand-50
                    focus:bg-white placeholder:text-brand-300", placeholder="e.g. Apple, Samsung, Dell...") }}
                </div>

                <!-- Submit -->
                <div class="mt-12 text-center opacity-30 pointer-events-none transition-all duration-500"
                    id="submitContainer">
                    <button type="submit" id="submitBtn"
                        class="bg-brand-900 text-white font-bold py-4 px-10 rounded-full shadow-lg hover:bg-black hover:scale-105 active:scale-95 transition-all duration-300 w-full md:w-auto min-w-[200px]">
                        <span id="btnText">Execute Expert System</span>
                        <span id="btnLoader" class="hidden flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            Analyzing...
                        </span>
                    </button>
                    <p class="mt-4 text-xs text-brand-400">Powered by logical inference engine v2.0</p>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('recommendForm');
        const sections = document.querySelectorAll('.question-section');
        const submitContainer = document.getElementById('submitContainer');
        const progressBar = document.getElementById('progressBar');
        const currentStepDisplay = document.getElementById('currentStepDisplay');
        const totalSteps = 4;
        let currentStep = 1;

        function activateSection(index) {
            if (index >= sections.length) {
                // Show submit button fully
                submitContainer.classList.remove('opacity-30', 'pointer-events-none');
                return;
            }

            const section = sections[index];
            section.classList.remove('opacity-30', 'pointer-events-none', 'blur-sm');

            // Scroll to it
            setTimeout(() => {
                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 200);

            // Update Progress
            currentStep = index + 1;
            if (currentStep > totalSteps) currentStep = totalSteps;

            // Update UI
            currentStepDisplay.textContent = currentStep;
            progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;
        }

        // 1. Category Interaction
        const categoryInputs = document.querySelectorAll('input[name="category"]');
        categoryInputs.forEach(input => {
            input.addEventListener('change', () => {
                activateSection(1); // Activate Budget (Index 1)
            });
        });

        // 2. Budget Interaction
        const budgetSlider = document.getElementById('budgetSlider');
        const budgetValue = document.getElementById('budgetValue');

        budgetSlider.addEventListener('input', function () {
            budgetValue.textContent = parseInt(this.value).toLocaleString();
        });

        budgetSlider.addEventListener('change', function () {
            activateSection(2); // Activate Usage (Index 2)
        });

        document.querySelectorAll('.budget-preset').forEach(btn => {
            btn.addEventListener('click', function () {
                budgetSlider.value = this.dataset.value;
                budgetValue.textContent = parseInt(this.dataset.value).toLocaleString();
                activateSection(2);
            });
        });

        // 3. Usage Interaction
        const usageInputs = document.querySelectorAll('input[name="usage_type"]');
        usageInputs.forEach(input => {
            input.addEventListener('change', () => {
                activateSection(3); // Activate Brand (Index 3)
            });
        });

        // 4. Brand Interaction
        const brandInput = document.querySelector('input[name="preferred_brand"]');
        brandInput.addEventListener('input', () => {
            // Just show submit button if typing starts
            submitContainer.classList.remove('opacity-30', 'pointer-events-none');
        });
        brandInput.addEventListener('focus', () => {
            submitContainer.classList.remove('opacity-30', 'pointer-events-none');
            activateSection(4); // Technically index 4 is out of bounds, effectively just finishes progress
        });


        // Submit Handling
        form.addEventListener('submit', function (e) {
            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');

            // Basic validation
            if (!document.querySelector('input[name="category"]:checked')) {
                e.preventDefault();
                alert('Please select a device type.');
                return;
            }

            btn.disabled = true;
            btnText.classList.add('hidden');
            btnLoader.classList.remove('hidden');
        });
    });
</script>
{% endblock %}