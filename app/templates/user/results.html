{% extends 'base.html' %}

{% block title %}Your Recommendations - TechAdvisor{% endblock %}

{% block content %}
<div class="min-h-screen bg-brand-50 py-12 md:py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-16 reveal">
            <h1 class="text-3xl md:text-5xl font-display font-bold text-brand-900 mb-6 tracking-tight">Your Personal
                Collection</h1>
            <p class="text-xl text-brand-500 max-w-2xl mx-auto font-light leading-relaxed">{{ message }}</p>

            <div
                class="mt-8 inline-flex items-center px-5 py-2.5 bg-white border border-brand-200 rounded-full shadow-sm text-brand-600 text-sm font-medium">
                <span class="w-2 h-2 rounded-full bg-brand-accent mr-3 animate-pulse"></span>
                Found {{ products|length }} matches based on {{ fired_rules }} expert rules
            </div>
        </div>

        {% if products %}
        <!-- Product Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-20" id="productGrid">
            {% for product in products %}
            <!-- Card -->
            <div class="bg-white rounded-3xl border border-brand-100 overflow-hidden hover:shadow-[0_20px_40px_-15px_rgba(0,0,0,0.1)] hover:-translate-y-1 transition-all duration-300 group flex flex-col h-full reveal"
                data-delay-index="{{ loop.index0 }}">

                <!-- Image Area -->
                <div
                    class="relative h-64 bg-brand-50 p-8 flex items-center justify-center group-hover:bg-brand-100/50 transition-colors">
                    <!-- Compare Checkbox -->
                    <div class="absolute top-4 left-4 z-10" onclick="event.stopPropagation()">
                        <label class="inline-flex items-center cursor-pointer group/check">
                            <input type="checkbox" onchange="handleSelection(this, '{{ product.id }}')"
                                class="peer sr-only">
                            <div
                                class="w-6 h-6 rounded-lg border-2 border-brand-200 bg-white flex items-center justify-center peer-checked:bg-brand-900 peer-checked:border-brand-900 transition-all hover:border-brand-400 shadow-sm">
                                <svg class="w-3.5 h-3.5 text-white opacity-0 peer-checked:opacity-100 transition-opacity"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span
                                class="ml-2 text-xs font-bold text-brand-600 opacity-0 group-hover/check:opacity-100 transition-opacity peer-checked:opacity-100 bg-white/80 backdrop-blur-sm px-2 py-1 rounded-md shadow-sm">Compare</span>
                        </label>
                    </div>
                    {% if product.image_url %}
                    <img src="{{ product.image_url }}" alt="{{ product.name }}"
                        class="max-h-full max-w-full object-contain mix-blend-multiply filter contrast-105 group-hover:scale-105 transition-transform duration-500">
                    {% else %}
                    <div class="text-brand-300">
                        <svg class="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    {% endif %}

                    <!-- Confidence Badge -->
                    <div class="absolute top-4 right-4">
                        <div
                            class="bg-white/90 backdrop-blur-sm border border-brand-200 text-brand-900 px-3 py-1 rounded-full text-xs font-bold shadow-sm">
                            {{ product.confidence }}% Match
                        </div>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="p-8 flex-1 flex flex-col">
                    <div
                        class="mb-4 flex items-center space-x-2 text-xs font-semibold uppercase tracking-wider text-brand-400">
                        <span>{{ product.brand }}</span>
                        <span class="text-brand-200">&bull;</span>
                        <span>{{ product.category }}</span>
                    </div>

                    <h3 class="text-xl font-bold text-brand-900 mb-3 leading-tight">{{ product.name }}</h3>
                    <p class="text-brand-500 text-sm mb-6 line-clamp-2 leading-relaxed">{{ product.description }}</p>

                    <!-- Price -->
                    <div class="text-3xl font-display font-bold text-brand-900 mb-6">
                        ${{ "%.0f"|format(product.price) }}<span class="text-lg text-brand-400 font-normal">.99</span>
                    </div>

                    <!-- AI Reasoning Box -->
                    <div class="bg-brand-50 rounded-2xl p-5 mb-8 flex-1">
                        <div class="flex items-start">
                            <div class="bg-brand-900 text-white p-1 rounded-md mr-3 mt-0.5">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-brand-900 uppercase tracking-wide mb-2">Why it fits
                                    you</h4>
                                <ul class="space-y-2">
                                    {% if product.reasoning_points %}
                                    {% for point in product.reasoning_points %}
                                    <li class="text-xs text-brand-600 leading-relaxed flex items-start">
                                        <span class="text-brand-300 mr-2 opacity-50">&mdash;</span>
                                        {{ point }}
                                    </li>
                                    {% endfor %}
                                    {% else %}
                                    <li class="text-xs text-brand-600 leading-relaxed">{{ product.reasoning }}</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Action -->
                    <a href="{{ url_for('user.product_detail', product_id=product.id) }}"
                        class="block w-full bg-brand-900 hover:bg-black text-white font-medium py-4 rounded-xl transition-all shadow-lg hover:shadow-xl active:scale-95 text-center">
                        View Details
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Try Again / Footer Action -->
        <div class="text-center pb-20">
            <p class="text-brand-400 mb-4">Not quite right?</p>
            <a href="{{ url_for('user.recommend') }}"
                class="inline-flex items-center px-8 py-3 bg-white border border-brand-200 text-brand-900 font-medium rounded-full hover:bg-brand-50 hover:border-brand-300 transition-colors">
                <svg class="w-4 h-4 mr-2 text-brand-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
                Restart Analysis
            </a>
        </div>

        {% else %}
        <!-- No Results State -->
        <div class="max-w-lg mx-auto text-center py-20">
            <div class="w-24 h-24 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-8">
                <svg class="w-10 h-10 text-brand-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-brand-900 mb-4">No perfect matches found.</h2>
            <p class="text-brand-500 mb-8 leading-relaxed">Our expert rules are strict. Try adjusting your budget or
                usage criteria to see more options.</p>
            <a href="{{ url_for('user.recommend') }}"
                class="inline-flex items-center px-6 py-3 bg-brand-900 text-white font-medium rounded-full hover:bg-black transition-colors">
                Adjust Preferences
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Comparison Floating Bar -->
    <div id="compareBar"
        class="fixed bottom-0 inset-x-0 bg-white/90 backdrop-blur-xl border-t border-brand-200 p-4 shadow-[0_-10px_40px_-5px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-500 z-50">
        <div class="max-w-4xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4 animate-pulse-once">
                <div class="bg-brand-900 text-white w-10 h-10 flex items-center justify-center rounded-xl font-display font-bold text-lg shadow-lg shadow-brand-900/20"
                    id="selectedCount">0</div>
                <div>
                    <p class="text-brand-900 font-bold leading-tight">Products Selected</p>
                    <p class="text-xs text-brand-500 font-medium">Select up to 4 items</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="clearSelection()"
                    class="text-sm text-brand-500 hover:text-brand-900 font-bold px-4 py-2 hover:bg-brand-50 rounded-lg transition-colors">
                    Clear
                </button>
                <div class="h-8 w-px bg-brand-200 mx-1"></div>
                <button onclick="submitCompare('specs')"
                    class="bg-white border border-brand-200 text-brand-900 hover:bg-brand-50 px-6 py-3 rounded-xl font-bold shadow-sm hover:shadow transition-all text-sm">
                    Compare Specs
                </button>
                <button onclick="submitCompare('analysis')"
                    class="bg-brand-900 hover:bg-black text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Compare Pros / Cons
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[data-delay-index]').forEach(el => {
            const index = parseInt(el.dataset.delayIndex, 10);
            if (!isNaN(index)) {
                el.style.animationDelay = (index * 100) + 'ms';
            }
        });
    });
    let selectedProducts = new Set();
    const MAX_SELECTION = 4;

    function handleSelection(checkbox, id) {
        if (checkbox.checked) {
            if (selectedProducts.size >= MAX_SELECTION) {
                checkbox.checked = false;
                alert(`You can only compare up to ${MAX_SELECTION} products at a time.`);
                return;
            }
            selectedProducts.add(id);
        } else {
            selectedProducts.delete(id);
        }
        updateCompareBar();
    }

    function updateCompareBar() {
        const bar = document.getElementById('compareBar');
        const countSpan = document.getElementById('selectedCount');

        countSpan.textContent = selectedProducts.size;

        if (selectedProducts.size > 0) {
            bar.classList.remove('translate-y-full');
        } else {
            bar.classList.add('translate-y-full');
        }
    }

    function clearSelection() {
        selectedProducts.clear();
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateCompareBar();
    }

    function submitCompare(type) {
        if (selectedProducts.size < 2) {
            alert('Please select at least 2 products to compare.');
            return;
        }

        if (type === 'analysis' && selectedProducts.size !== 2) {
            alert('Pros & Cons analysis strictly requires exactly 2 products.');
            return;
        }

        const ids = Array.from(selectedProducts).join(',');
        const route = type === 'analysis' ? "{{ url_for('user.compare_analysis') }}" : "{{ url_for('user.compare') }}";
        window.location.href = `${route}?ids=${ids}`;
    }
</script>
{% endblock %}